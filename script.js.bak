// Database Management using LocalStorage
class DatabaseManager {
    constructor() {
        this.init();
    }

    init() {
        if (!localStorage.getItem('students')) {
            localStorage.setItem('students', JSON.stringify([]));
        }
        if (!localStorage.getItem('contracts')) {
            localStorage.setItem('contracts', JSON.stringify([]));
        }
        if (!localStorage.getItem('appSettings')) {
            localStorage.setItem('appSettings', JSON.stringify({
                schoolStampText: 'Ù…Ø¯Ø§Ø±Ø³ Ø¯Ø§Ù†Ø© Ø§Ù„Ø¹Ù„ÙˆÙ… - Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©',
                levels: ['Ø§Ù„Ø·ÙÙˆÙ„Ø© Ø§Ù„Ù…Ø¨ÙƒØ±Ø©', 'Ø±ÙŠØ§Ø¶ Ø£Ø·ÙØ§Ù„', 'Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©', 'Ø§Ù„Ù…ØªÙˆØ³Ø·Ø©', 'Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ©'],
                grades: ['Ù…Ø³ØªÙˆÙ‰ Ø£ÙˆÙ„', 'Ù…Ø³ØªÙˆÙ‰ Ø«Ø§Ù†ÙŠ', 'Ù…Ø³ØªÙˆÙ‰ Ø«Ø§Ù„Ø«', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12'],
                adminUsername: 'admin',
                adminPassword: 'admin',
                schoolLogo: '' // Base64 string
            }));
        }

        // Initialize Cloud Sync if available
        if (typeof CloudDB !== 'undefined' && isFirebaseConfigured) {
            console.log('â˜ï¸ Connecting to Firebase...');

            // Listen for updates
            CloudDB.listenForUpdates(remoteStudents => {
                this.mergeRemoteData(remoteStudents);
            });

            // One-time check: If local has data and cloud is unknown, try to sync up
            // Checks if we haven't synced before in this session
            if (!sessionStorage.getItem('initialSyncDone')) {
                const localData = this.getStudents();
                if (localData.length > 0) {
                    CloudDB.getStudents().then(cloudData => {
                        if (cloudData.length === 0) {
                            console.log('â˜ï¸ Cloud empty, uploading local data...');
                            CloudDB.syncLocalToCloud();
                        }
                    });
                }
                sessionStorage.setItem('initialSyncDone', 'true');
            }
        }
    }

    // Merge remote data into local storage (Conflict resolution: Latest wins or simple merge)
    mergeRemoteData(remoteStudents) {
        if (!remoteStudents || !Array.isArray(remoteStudents)) return;

        const localStudents = this.getStudents();
        let hasChanges = false;

        remoteStudents.forEach(remote => {
            const localIdx = localStudents.findIndex(l => String(l.id) === String(remote.id));
            if (localIdx === -1) {
                // New student from cloud
                localStudents.push(remote);
                hasChanges = true;
            } else {
                // Update existing if different (Simple check or timestamp check if available)
                // For now, allow cloud to overwrite local as it's the source of truth for signed contracts
                const local = localStudents[localIdx];
                if (JSON.stringify(local) !== JSON.stringify(remote)) {
                    localStudents[localIdx] = remote;
                    hasChanges = true;
                }
            }
        });

        if (hasChanges) {
            localStorage.setItem('students', JSON.stringify(localStudents));
            console.log('ğŸ”„ Local data updated from Cloud');

            // Trigger UI refresh if UI exists
            if (typeof UI !== 'undefined' && UI.refreshData) {
                UI.refreshData();
            }
        }
    }

    getSettings() {
        const defaults = {
            schoolStampText: 'Ù…Ø¯Ø§Ø±Ø³ Ø¯Ø§Ù†Ø© Ø§Ù„Ø¹Ù„ÙˆÙ… - Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©',
            levels: ['Ø§Ù„Ø·ÙÙˆÙ„Ø© Ø§Ù„Ù…Ø¨ÙƒØ±Ø©', 'Ø±ÙŠØ§Ø¶ Ø£Ø·ÙØ§Ù„', 'Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©', 'Ø§Ù„Ù…ØªÙˆØ³Ø·Ø©', 'Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ©'],
            grades: ['Ù…Ø³ØªÙˆÙ‰ Ø£ÙˆÙ„', 'Ù…Ø³ØªÙˆÙ‰ Ø«Ø§Ù†ÙŠ', 'Ù…Ø³ØªÙˆÙ‰ Ø«Ø§Ù„Ø«', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12'],
            adminUsername: 'admin',
            adminPassword: 'admin',
            schoolLogo: '',
            customFields: []
        };
        try {
            const savedRaw = localStorage.getItem('appSettings');
            if (!savedRaw) return defaults;
            const saved = JSON.parse(savedRaw);
            if (typeof saved !== 'object' || saved === null) return defaults;
            return { ...defaults, ...saved };
        } catch (e) {
            console.error('Error loading settings:', e);
            return defaults;
        }
    }

    saveSettings(settings) {
        localStorage.setItem('appSettings', JSON.stringify(settings));
    }

    getStudents() {
        return JSON.parse(localStorage.getItem('students') || '[]');
    }

    saveStudent(student) {
        const students = this.getStudents();
        const existingIndex = students.findIndex(s => s.id === student.id);

        if (student.id && existingIndex !== -1) {
            // Update existing
            students[existingIndex] = { ...students[existingIndex], ...student };
        } else {
            // Create new
            if (!student.id) student.id = Date.now().toString();
            if (!student.contractStatus) student.contractStatus = 'pending';
            if (!student.createdAt) student.createdAt = new Date().toISOString();
            students.push(student);
        }

        localStorage.setItem('students', JSON.stringify(students));

        // Sync to Cloud
        if (typeof CloudDB !== 'undefined') {
            CloudDB.saveStudent(student);
        }

        return student;
    }

    saveBulkStudents(studentsArray) {
        const students = this.getStudents();
        const newStudents = studentsArray.map(s => ({
            ...s,
            id: Date.now().toString() + Math.random(),
            contractStatus: 'pending',
            createdAt: new Date().toISOString()
        }));
        students.push(...newStudents);
        localStorage.setItem('students', JSON.stringify(students));

        // Sync to Cloud
        if (typeof CloudDB !== 'undefined') {
            newStudents.forEach(s => CloudDB.saveStudent(s));
        }

        return newStudents;
    }

    updateStudentStatus(id, status) {
        const students = this.getStudents();
        const student = students.find(s => s.id === id);
        if (student) {
            student.contractStatus = status;
            localStorage.setItem('students', JSON.stringify(students));

            // Sync to Cloud
            if (typeof CloudDB !== 'undefined') {
                CloudDB.saveStudent(student);
            }
        }
    }

    deleteStudent(id) {
        const students = this.getStudents();
        const filtered = students.filter(s => s.id !== id);
        localStorage.setItem('students', JSON.stringify(filtered));

        // Sync delete to Cloud
        if (typeof CloudDB !== 'undefined') {
            CloudDB.deleteStudent(id);
        }
    }

    getStats() {
        const students = this.getStudents();
        return {
            total: students.length,
            signed: students.filter(s => s.contractStatus === 'signed' || s.contractStatus === 'verified').length,
            pending: students.filter(s => s.contractStatus === 'pending').length,
            sent: students.filter(s => s.contractStatus === 'sent').length
        };
    }

    // New helper for real-time remote updates
    updateFromRemote() {
        UI.updateStats();
        UI.renderStudents();
        if (typeof ContractUI !== 'undefined' && ContractUI.renderSignedContracts) {
            ContractUI.renderSignedContracts();
        }
    }
}

const db = new DatabaseManager();

// UI Management
const UI = {
    modal: document.getElementById('newStudentModal'),
    studentForm: document.getElementById('studentForm'),
    tableBody: document.getElementById('studentsTableBody'),

    // Bulk Selection Logic - Temporarily Disabled
    handleSelectionChange() {
        console.log('Selection handler disabled');
    },

    deleteSelectedStudents() {
        console.log('Delete function disabled');
    },

    openModal() {
        this.modal.classList.add('active');

        // Populate Contract Templates
        const templateSelect = document.getElementById('contractTemplate');
        if (templateSelect) {
            let templates = JSON.parse(localStorage.getItem('contractTemplates') || '[]');

            // Generate default if empty
            if (templates.length === 0) {
                // We rely on contract.js/initialization usually, but let's be safe
                templates = [{ id: 'default', title: 'Ø¹Ù‚Ø¯ ØªØ³Ø¬ÙŠÙ„ Ù…ÙˆØ­Ø¯', isDefault: true }];
            }

            templateSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¹Ù‚Ø¯</option>' +
                templates.map(t => `<option value="${t.id}" ${t.isDefault ? 'selected' : ''}>${t.title}</option>`).join('');
        }
    },

    closeModal() {
        this.modal.classList.remove('active');
        this.studentForm.reset();
        // Reset editing state
        delete this.studentForm.dataset.editingId;
        const title = document.querySelector('#newStudentModal h3');
        const btn = document.querySelector('#newStudentModal button[type="submit"]');
        if (title) title.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯';
        if (btn) btn.textContent = 'Ø­ÙØ¸ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¹Ù‚Ø¯';
    },

    updateStats() {
        const stats = db.getStats();
        const totalEl = document.getElementById('totalStudents');
        if (totalEl) totalEl.textContent = stats.total;

        const signedEl = document.getElementById('signedContracts');
        if (signedEl) signedEl.textContent = stats.signed;

        const pendingEl = document.getElementById('pendingContracts');
        if (pendingEl) pendingEl.textContent = stats.pending;

        const sentEl = document.getElementById('sentContracts');
        if (sentEl) sentEl.textContent = stats.sent;
    },

    renderStudents(filteredStudents = null) {
        const students = filteredStudents || db.getStudents();
        const reversedStudents = [...students].reverse();

        if (!this.tableBody) return;

        const renderRow = (student) => `
            <tr>
                <td><input type="checkbox" class="student-checkbox" value="${student.id}"></td>
                <td><strong>${student.studentName}</strong></td>
                <td>${student.studentLevel || ''} - ${student.studentGrade}</td>
                <td>${student.parentName}</td>
                <td dir="ltr">${student.parentWhatsapp}</td>
                <td>${this.getStatusBadge(student.contractStatus)}</td>
                <td>
                    <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                        <button class="btn-icon" onclick="UI.copyContractLink('${student.id}')" title="Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ø¹Ù‚Ø¯" style="color: #667eea;">
                             <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>
                        </button>
                        ${student.contractStatus === 'signed' ? `
                        <button class="btn-icon" onclick="markAsSigned('${student.id}')" title="ØªØ£ÙƒÙŠØ¯ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¹Ù‚Ø¯ (ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± ÙˆÙ‚Ù‘Ø¹)" style="color: #38b2ac;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                        </button>
                        ` : ''}
                        <button class="btn-icon" onclick="${student.contractStatus === 'signed' || student.contractStatus === 'verified' ? `UI.downloadContractPdf('${student.id}')` : `UI.printContract('${student.id}')`}" title="Ø·Ø¨Ø§Ø¹Ø©/ØªØ­Ù…ÙŠÙ„">
                             <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>
                        </button>
                        <button class="btn-icon" onclick="UI.editStudent('${student.id}')" title="ØªØ¹Ø¯ÙŠÙ„">
                             <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                        </button>
                        <button class="btn-icon" onclick="UI.sendContract('${student.id}')" title="Ø¥Ø±Ø³Ø§Ù„">
                             <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                        </button>
                        ${student.contractStatus === 'signed' || student.contractStatus === 'verified' ? `
                        <button class="btn-icon" onclick="UI.deleteSignedContent('${student.id}')" title="Ø­Ø°Ù Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ ÙˆØ§Ù„Ù‡ÙˆÙŠØ© (Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹Ù…ÙŠØ¯)" style="color: #e53e3e;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                        </button>
                        ` : ''}
                        <button class="btn-icon" onclick="UI.deleteStudent('${student.id}')" title="Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨">
                             <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                        </button>
                    </div>
                </td>
            </tr>
        `;

        // Dashboard Table
        const dashboardTable = document.getElementById('studentsTableBody');
        if (dashboardTable) {
            dashboardTable.innerHTML = reversedStudents.slice(0, 5).map(renderRow).join('');
            if (reversedStudents.length === 0) dashboardTable.innerHTML = '<tr><td colspan="7" class="text-center p-4">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨</td></tr>';
        }

        // All Students Page Table
        const allTable = document.getElementById('allStudentsTableBody');
        if (allTable) {
            allTable.innerHTML = reversedStudents.map(renderRow).join('');
            if (reversedStudents.length === 0) allTable.innerHTML = '<tr><td colspan="7" class="text-center p-4">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ù…Ø³Ø¬Ù„ÙŠÙ†</td></tr>';
        }

        // Initialize Select All checkboxes
        const initSelectAll = (headerCheckId, bodyContainerId) => {
            const headerCheck = document.getElementById(headerCheckId);
            const container = document.getElementById(bodyContainerId);
            if (headerCheck && container) {
                // Reset header check when re-rendering
                headerCheck.checked = false;

                // Clone to remove old listeners
                const newHeaderCheck = headerCheck.cloneNode(true);
                headerCheck.parentNode.replaceChild(newHeaderCheck, headerCheck);

                newHeaderCheck.addEventListener('change', () => {
                    const checks = container.querySelectorAll('.student-checkbox');
                    checks.forEach(c => c.checked = newHeaderCheck.checked);
                    UI.handleSelectionChange();
                });
            }
        };

        // Attach listeners to individual checkboxes
        const checkboxes = document.querySelectorAll('.student-checkbox');
        checkboxes.forEach(cb => {
            cb.addEventListener('change', () => UI.handleSelectionChange());
        });

        initSelectAll('selectAllDashboard', 'studentsTableBody');
        initSelectAll('selectAllAllStudents', 'allStudentsTableBody');

        // Reset bulk selection UI
        UI.handleSelectionChange();
    },

    getStatusBadge(status) {
        const badges = {
            pending: '<span class="status-badge status-pending">Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</span>',
            sent: '<span class="status-badge status-sent">ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</span>',
            signed: '<span class="status-badge status-signed">Ù…ÙˆÙ‚Ù‘Ø¹ (Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯)</span>',
            verified: '<span class="status-badge status-verified" style="background: #059669; color: white;">ØªÙ… Ø§Ù„ØªÙˆØ«ÙŠÙ‚</span>'
        };
        return badges[status] || badges.pending;
    },

    sendContract(id) {
        const students = db.getStudents();
        const student = students.find(s => s.id === id);

        if (student) {
            // Intelligent base path detection
            let basePath = window.location.href;
            if (basePath.indexOf('?') > -1) basePath = basePath.split('?')[0];
            if (basePath.endsWith('index.html')) basePath = basePath.replace('index.html', '');
            if (basePath.endsWith('/')) basePath = basePath.slice(0, -1);

            // Fetch Template Data to include in URL
            let templateTitle = '';
            let templateContent = '';
            const templates = JSON.parse(localStorage.getItem('contractTemplates') || '[]');
            const template = templates.find(t => t.id === student.contractTemplateId) || templates.find(t => t.isDefault) || templates[0];
            if (template) {
                templateTitle = template.title;
                templateContent = template.content;
            }

            // Create highly optimized data payload
            const secureData = {
                i: student.id,
                s: student.studentName,
                l: student.studentLevel,
                g: student.studentGrade,
                p: student.parentName,
                e: student.parentEmail,
                w: student.parentWhatsapp,
                y: student.contractYear,
                t: templateTitle,
                c: templateContent,
                st: 2 // Start at step 2 (Upload ID)
            };

            // Use LZString for maximum compression (High efficiency)
            const compressed = LZString.compressToEncodedURIComponent(JSON.stringify(secureData));
            const contractUrl = `${basePath}/contract.html?c=${compressed}`;

            const message = `*Ø¹Ù‚Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ - Ù…Ø¯Ø§Ø±Ø³ Ø¯Ø§Ù†Ø© Ø§Ù„Ø¹Ù„ÙˆÙ…* ğŸ«
            
Ù…Ø±Ø­Ø¨Ø§Ù‹ ${student.parentName},
ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ø·Ù„Ø§Ø¹ Ø¹Ù„Ù‰ Ø¹Ù‚Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ø·Ø§Ù„Ø¨/Ø©: *${student.studentName}*

Ù„Ù„ØªØ¹Ù…ÙŠØ¯ ÙˆØ§Ù„ØªÙˆÙ‚ÙŠØ¹ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ§Ù„ÙŠ:
ğŸ‘‡ Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„Ù„ØªÙˆÙ‚ÙŠØ¹ ğŸ‘‡
${contractUrl}

Ù…Ø¹ ØªØ­ÙŠØ§ØªØŒ
*Ù…Ø¯Ø§Ø±Ø³ Ø¯Ø§Ù†Ø© Ø§Ù„Ø¹Ù„ÙˆÙ…*`.trim();

            let actionsTaken = [];

            // 1. WhatsApp Action
            if (student.sendMethod === 'whatsapp' || student.sendMethod === 'both') {
                let phone = student.parentWhatsapp.replace(/[^\d]/g, '');

                // Add Saudi code if missing or 05 format
                if (phone.startsWith('05')) {
                    phone = '966' + phone.substring(1);
                } else if (phone.startsWith('5')) {
                    phone = '966' + phone;
                }

                const whatsappUrl = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');
                actionsTaken.push('ÙˆØ§ØªØ³Ø§Ø¨');
            }

            // 2. Email Action
            if (student.sendMethod === 'email' || student.sendMethod === 'both') {
                const subject = encodeURIComponent(`Ø¹Ù‚Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨ ${student.studentName}`);
                const body = encodeURIComponent(message);
                const mailtoLink = `mailto:${student.parentEmail}?subject=${subject}&body=${body}`;

                window.open(mailtoLink, '_self');

                // Feedback for email
                setTimeout(() => {
                    UI.showNotification('ØªÙ… ÙØªØ­ Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ');
                }, 800);
                actionsTaken.push('Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ');
            }

            // Update status
            db.updateStudentStatus(id, 'sent');
            this.updateStats();
            this.renderStudents();
            this.showNotification(`ØªÙ… Ø§Ù„Ø¨Ø¯Ø¡ Ø¨Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø¨Ø± ${actionsTaken.join(' Ùˆ ')}`);

            // Allow manual copy
            setTimeout(() => {
                const wantsCopy = confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ù„Ù„Ø§Ø­ØªÙŠØ§Ø·ØŸ');
                if (wantsCopy) {
                    navigator.clipboard.writeText(contractUrl).then(() => {
                        UI.showNotification('âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·!');
                    });
                }
            }, 1000);
        }
    },

    copyContractLink(id) {
        const students = db.getStudents();
        const student = students.find(s => String(s.id) === String(id));

        if (!student) {
            this.showNotification('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø§Ù„Ø¨');
            return;
        }

        // Build base path
        let basePath = window.location.href;
        if (basePath.indexOf('?') > -1) basePath = basePath.split('?')[0];
        if (basePath.endsWith('index.html')) basePath = basePath.replace('index.html', '');
        if (basePath.endsWith('/')) basePath = basePath.slice(0, -1);

        // Get template data
        let templateTitle = '';
        let templateContent = '';
        const templates = JSON.parse(localStorage.getItem('contractTemplates') || '[]');
        const template = templates.find(t => t.id === student.contractTemplateId) || templates.find(t => t.isDefault) || templates[0];
        if (template) {
            templateTitle = template.title;
            templateContent = template.content;
        }

        // Create compressed data
        const secureData = {
            i: student.id,
            s: student.studentName,
            l: student.studentLevel,
            g: student.studentGrade,
            p: student.parentName,
            e: student.parentEmail,
            w: student.parentWhatsapp,
            y: student.contractYear,
            t: templateTitle,
            c: templateContent,
            st: 2
        };

        const compressed = LZString.compressToEncodedURIComponent(JSON.stringify(secureData));
        const contractUrl = `${basePath}/contract.html?c=${compressed}`;

        // Copy to clipboard
        navigator.clipboard.writeText(contractUrl).then(() => {
            this.showNotification('âœ… ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ø¹Ù‚Ø¯ Ø¨Ù†Ø¬Ø§Ø­!');
        }).catch(err => {
            console.error('Copy failed:', err);
            // Fallback for older browsers
            const textArea = document.createElement('textarea');
            textArea.value = contractUrl;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            this.showNotification('âœ… ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ø¹Ù‚Ø¯!');
        });
    },

    getContractSummaryHTML(student) {
        const settings = db.getSettings();
        const stampText = settings.schoolStampText || 'Ù…Ø¯Ø§Ø±Ø³ Ø¯Ø§Ù†Ø© Ø§Ù„Ø¹Ù„ÙˆÙ…';
        const hasSignature = !!student.signature;
        const hasIdImage = !!student.idImage;

        // Get contract template
        const templates = JSON.parse(localStorage.getItem('contractTemplates') || '[]');
        const template = templates.find(t => t.id === student.contractTemplateId) || templates.find(t => t.isDefault) || templates[0];

        let contractContent = '';
        let contractTitle = 'Ø¹Ù‚Ø¯ ØªØ³Ø¬ÙŠÙ„';

        if (template) {
            contractTitle = template.title || contractTitle;
            contractContent = template.content || '';

            // Replace dynamic variables
            contractContent = contractContent
                .replace(/{Ø§Ø³Ù…_Ø§Ù„Ø·Ø§Ù„Ø¨}/g, student.studentName || '')
                .replace(/{Ø§Ø³Ù…_ÙˆÙ„ÙŠ_Ø§Ù„Ø§Ù…Ø±}/g, student.parentName || '')
                .replace(/{Ø§Ù„ØµÙ}/g, `Ø§Ù„ØµÙ ${student.studentGrade}` || '')
                .replace(/{Ø§Ù„Ù…Ø±Ø­Ù„Ø©_Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©}/g, student.studentLevel || '')
                .replace(/{Ø§Ù„Ø³Ù†Ø©_Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©}/g, student.contractYear || '')
                .replace(/{Ø§Ù„Ø¨Ø±ÙŠØ¯_Ø§Ù„Ø§Ù„ÙƒØªØ±ÙˆÙ†ÙŠ}/g, student.parentEmail || '')
                .replace(/{Ø±Ù‚Ù…_Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨}/g, student.parentWhatsapp || '')
                .replace(/{Ø§Ù„ØªØ§Ø±ÙŠØ®}/g, new Date().toLocaleDateString('ar-SA'))
                .replace(/\n/g, '<br>');
        }

        const stampHtml = student.contractStatus === 'verified' ?
            `<div style="width: 120px; height: 120px; border: 4px double #004d99; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto; transform: rotate(-15deg); color: #004d99; font-weight: bold; text-align: center; padding: 10px;">
                <div style="font-size: 10px;">Ù…Ø¯Ø§Ø±Ø³ Ø¯Ø§Ù†Ø© Ø§Ù„Ø¹Ù„ÙˆÙ…<br><span style="font-size: 12px; display:block; margin: 2px 0;">Ù…Ù€Ø¹Ù€ØªÙ€Ù…Ù€Ø¯</span><br>${stampText}</div>
            </div>` :
            `<div style="width: 120px; height: 120px; border: 2px dashed #cbd5e0; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto; color: #a0aec0; font-size: 12px;"> Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªÙˆØ«ÙŠÙ‚ </div>`;

        return `
            <div style="font-family: 'Cairo', Arial, sans-serif; direction: rtl; padding: 30px; border: 1px solid #eee; background: white;">
                <!-- Header -->
                <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid #667eea; margin-bottom: 30px; padding-bottom: 15px;">
                    <div>
                        <h1 style="color: #2d3748; margin: 0; font-size: 24px;">${contractTitle}</h1>
                        <p style="color: #718096; margin: 5px 0 0; font-size: 14px;">Ù†Ø¸Ø§Ù… Ø¯Ø§Ù†Ø© Ø§Ù„Ø¹Ù„ÙˆÙ… - ${new Date().toLocaleDateString('ar-SA')}</p>
                    </div>
                    ${settings.schoolLogo ? `<img src="${settings.schoolLogo}" style="height: 60px; width: auto;">` : `<img src="assets/logo.png" style="height: 60px; width: auto;">`}
                </div>

                <!-- Student Info -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                    <div style="background: #f8fafc; padding: 15px; border-radius: 12px; border: 1px solid #e2e8f0;">
                        <h3 style="margin-top: 0; color: #4a5568; font-size: 14px; border-bottom: 1px solid #cbd5e0; padding-bottom: 8px;">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨</h3>
                        <p style="margin: 8px 0; font-size: 13px;"><strong>Ø§Ù„Ø§Ø³Ù…:</strong> ${student.studentName}</p>
                        <p style="margin: 8px 0; font-size: 13px;"><strong>Ø§Ù„Ù…Ø±Ø­Ù„Ø©:</strong> ${student.studentLevel}</p>
                        <p style="margin: 8px 0; font-size: 13px;"><strong>Ø§Ù„ØµÙ:</strong> ${student.studentGrade}</p>
                        <p style="margin: 8px 0; font-size: 13px;"><strong>Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯:</strong> ${student.contractNo || 'N/A'}</p>
                    </div>
                    <div style="background: #f8fafc; padding: 15px; border-radius: 12px; border: 1px solid #e2e8f0;">
                        <h3 style="margin-top: 0; color: #4a5568; font-size: 14px; border-bottom: 1px solid #cbd5e0; padding-bottom: 8px;">Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</h3>
                        <p style="margin: 8px 0; font-size: 13px;"><strong>Ø§Ù„Ø§Ø³Ù…:</strong> ${student.parentName}</p>
                        <p style="margin: 8px 0; font-size: 13px;"><strong>Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨:</strong> ${student.parentWhatsapp}</p>
                        <p style="margin: 8px 0; font-size: 13px;"><strong>Ø§Ù„Ø¨Ø±ÙŠØ¯:</strong> ${student.parentEmail || '-'}</p>
                        <p style="margin: 8px 0; font-size: 13px;"><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> ${student.contractStatus === 'verified' ? 'ØªÙ… Ø§Ù„ØªÙˆØ«ÙŠÙ‚ âœ“' : 'Ù…ÙˆÙ‚Ø¹'}</p>
                    </div>
                </div>

                <!-- Contract Text -->
                <div style="background: #fffbeb; padding: 20px; border-radius: 12px; border: 1px solid #fcd34d; margin-bottom: 30px;">
                    <h3 style="margin-top: 0; color: #92400e; font-size: 16px; margin-bottom: 15px;">ğŸ“œ Ù†Øµ Ø§Ù„Ø¹Ù‚Ø¯</h3>
                    <div style="color: #1f2937; font-size: 14px; line-height: 1.8;">
                        ${contractContent || '<p style="color:#a0aec0;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Øµ Ø¹Ù‚Ø¯ Ù…Ø­Ø¯Ø¯</p>'}
                    </div>
                </div>

                <!-- ID Image -->
                <div style="margin-bottom: 30px;">
                    <h3 style="color: #4a5568; font-size: 16px; margin-bottom: 10px;">ğŸ“· ØµÙˆØ±Ø© Ø§Ù„Ù‡ÙˆÙŠØ© Ø§Ù„Ù…Ø±ÙÙ‚Ø©:</h3>
                    ${hasIdImage ? `<img src="${student.idImage}" style="max-width: 100%; border-radius: 8px; border: 1px solid #ddd; max-height: 300px;">` : '<p style="color: #a0aec0; border: 1px dashed #ccc; padding: 20px; text-align: center; border-radius: 8px;">Ù„Ù… ÙŠØªÙ… Ø¥Ø±ÙØ§Ù‚ ØµÙˆØ±Ø© Ø§Ù„Ù‡ÙˆÙŠØ©</p>'}
                </div>

                <!-- Signature and Stamp -->
                <div style="display: flex; justify-content: space-between; align-items: flex-end; padding-top: 30px; border-top: 2px solid #eee;">
                    <div style="text-align: center; width: 45%;">
                        <h4 style="margin-bottom: 10px; color: #4a5568;">âœï¸ ØªÙˆÙ‚ÙŠØ¹ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</h4>
                        ${hasSignature ? `<img src="${student.signature}" style="max-width: 200px; max-height: 100px; border: 1px solid #eee; padding: 5px; border-radius: 8px; background: #fafafa;">` : '<div style="height: 80px; border: 1px dashed #ccc; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #a0aec0;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙˆÙ‚ÙŠØ¹</div>'}
                        <p style="font-size: 12px; color: #718096; margin-top: 10px;">ØªÙ… Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Ù‹ Ø¨ØªØ§Ø±ÙŠØ®: ${student.signedAt ? new Date(student.signedAt).toLocaleDateString('ar-SA') : '-'}</p>
                    </div>
                    
                    <div style="text-align: center; width: 45%;">
                        <h4 style="margin-bottom: 10px; color: #4a5568;">ğŸ« Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</h4>
                        ${stampHtml}
                    </div>
                </div>
                
                <div style="margin-top: 50px; text-align: center; color: #a0aec0; font-size: 10px;">Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø¯ ØªÙ… ØªÙˆÙ„ÙŠØ¯Ù‡ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Ù‹ Ù…Ù† Ù…Ù†ØµØ© Ù…Ø¯Ø§Ø±Ø³ Ø¯Ø§Ù†Ø© Ø§Ù„Ø¹Ù„ÙˆÙ….</div>
                
                ${(student.contractStatus === 'signed' || student.contractStatus === 'verified') ? `
                <div style="margin-top: 30px; display: flex; flex-direction: column; align-items: center; border: 1px solid #edf2f7; padding: 15px; border-radius: 8px; width: 220px; float: left;">
                    <div id="pdf-qrcode" style="margin-bottom: 8px;"></div>
                    <div style="font-size: 10px; color: #718096; text-align: center;">Ø§Ù…Ø³Ø­ Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¹Ù‚Ø¯<br>Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯: ${student.contractNo || student.id}</div>
                </div>
                <div style="clear: both;"></div>
                ` : ''}
            </div>
        `;
    },

    downloadContractPdf(id) {
        console.log('PDF Download requested', id);
        alert('ÙˆØ¸ÙŠÙØ© PDF ØªØ­Øª Ø§Ù„ØµÙŠØ§Ù†Ø©');
    },

    previewContract(id) {
        const students = db.getStudents();
        const student = students.find(s => String(s.id) === String(id));

        if (!student) {
            console.error('Student not found for preview:', id);
            return;
        }

        console.log('Preview student data:', {
            id: student.id,
            hasSignature: !!student.signature,
            hasIdImage: !!student.idImage,
            status: student.contractStatus
        });

        const summaryHtml = this.getContractSummaryHTML(student);
        const modal = document.getElementById('contractPreviewModal');
        const body = document.getElementById('contractPreviewBody');

        if (modal && body) {
            body.innerHTML = summaryHtml;
            modal.classList.add('active');

            // Generate QR code for signed or verified contracts
            if (student.contractStatus === 'signed' || student.contractStatus === 'verified') {
                const qrDiv = body.querySelector('#pdf-qrcode');
                if (qrDiv) {
                    // Use local verification URL
                    let basePath = window.location.href;
                    if (basePath.indexOf('?') > -1) basePath = basePath.split('?')[0];
                    if (basePath.endsWith('index.html')) basePath = basePath.replace('index.html', '');
                    if (basePath.endsWith('/')) basePath = basePath.slice(0, -1);

                    const verifyUrl = `${basePath}/contract.html?id=${student.id}`;

                    new QRCode(qrDiv, {
                        text: verifyUrl,
                        width: 80,
                        height: 80,
                        colorDark: "#004d99",
                        colorLight: "#ffffff"
                    });
                }
            }
        }
    },

    closePreviewModal() {
        const modal = document.getElementById('contractPreviewModal');
        if (modal) modal.classList.remove('active');
    },

    editStudent(id) {
        const students = db.getStudents();
        const student = students.find(s => s.id === id);

        if (student) {
            // Fill form
            const setVal = (id, val) => {
                const el = document.getElementById(id);
                if (el) el.value = val || '';
            };

            setVal('studentName', student.studentName);
            setVal('studentLevel', student.studentLevel);
            setVal('studentGrade', student.studentGrade);
            setVal('parentName', student.parentName);
            setVal('parentEmail', student.parentEmail);
            setVal('parentWhatsapp', student.parentWhatsapp);
            setVal('sendMethod', student.sendMethod);
            setVal('contractYear', student.contractYear);

            const template = document.getElementById('contractTemplate');
            if (template && student.contractTemplateId) {
                template.value = student.contractTemplateId;
            }

            // Fill custom fields
            if (student.customData) {
                Object.keys(student.customData).forEach(label => {
                    const input = document.querySelector(`#dynamicCustomFieldsContainer input[data-custom-label="${label}"]`);
                    if (input) input.value = student.customData[label];
                });
            }

            // Set Editing State
            if (this.studentForm) {
                this.studentForm.dataset.editingId = id;
                const modalTitle = document.querySelector('#newStudentModal h3');
                const submitBtn = document.querySelector('#newStudentModal button[type="submit"]');
                if (modalTitle) modalTitle.textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨';
                if (submitBtn) submitBtn.textContent = 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª';
            }

            this.openModal();
        }
    },

    printContract(id) {
        const students = db.getStudents();
        const student = students.find(s => s.id === id);
        if (!student) return;

        let basePath = window.location.href;
        if (basePath.indexOf('?') > -1) basePath = basePath.split('?')[0];
        if (basePath.endsWith('index.html')) basePath = basePath.replace('index.html', '');
        if (basePath.endsWith('/')) basePath = basePath.slice(0, -1);

        // Fetch Template Data
        let templateTitle = '';
        let templateContent = '';
        const templates = JSON.parse(localStorage.getItem('contractTemplates') || '[]');
        const template = templates.find(t => t.id === student.contractTemplateId) || templates.find(t => t.isDefault) || templates[0];
        if (template) {
            templateTitle = template.title;
            templateContent = template.content;
        }

        const secureData = {
            i: student.id,
            s: student.studentName,
            l: student.studentLevel,
            g: student.studentGrade,
            p: student.parentName,
            e: student.parentEmail,
            w: student.parentWhatsapp,
            y: student.contractYear,
            t: templateTitle,
            c: templateContent,
            st: student.contractStatus === 'signed' ? 4 : 1
        };

        const compressed = LZString.compressToEncodedURIComponent(JSON.stringify(secureData));
        window.open(`${basePath}/contract.html?c=${compressed}&print=true`, '_blank');
    },

    deleteStudent(id) {
        if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.')) {
            db.deleteStudent(id);
            this.updateStats();
            this.renderStudents();
            this.showNotification('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­!');
        }
    },

    deleteSignedContent(id) {
        console.log('deleteSignedContent called with id:', id);

        if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ ÙˆØµÙˆØ±Ø© Ø§Ù„Ù‡ÙˆÙŠØ© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨ØŸ\n\n- Ø³ÙŠØªÙ… Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ ÙˆØ§Ù„Ù‡ÙˆÙŠØ©.\n- Ø³ØªØªØºÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¥Ù„Ù‰ "Ù…Ø±Ø³Ù„".\n- Ø³ÙŠØªÙ…ÙƒÙ† ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± Ù…Ù† Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù‚Ø¯.')) {
            const students = db.getStudents();
            const idx = students.findIndex(s => String(s.id) === String(id));

            console.log('Found student at index:', idx);

            if (idx !== -1) {
                console.log('Before deletion:', {
                    status: students[idx].contractStatus,
                    hasSignature: !!students[idx].signature,
                    hasIdImage: !!students[idx].idImage
                });

                // Clear all signing-related data
                students[idx].contractStatus = 'sent';
                students[idx].signature = null;
                students[idx].idImage = null;
                students[idx].signedAt = null;
                students[idx].verifiedAt = null;
                students[idx].contractNo = null;

                // Save to localStorage
                localStorage.setItem('students', JSON.stringify(students));

                console.log('After deletion:', {
                    status: students[idx].contractStatus,
                    hasSignature: !!students[idx].signature,
                    hasIdImage: !!students[idx].idImage
                });

                // Refresh all UI components
                this.updateStats();
                this.renderStudents();
                if (typeof ContractUI !== 'undefined') {
                    ContractUI.renderSignedContracts();
                }

                this.showNotification('âœ… ØªÙ… Ù…Ø³Ø­ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ ÙˆØ§Ù„Ù‡ÙˆÙŠØ© Ø¨Ù†Ø¬Ø§Ø­. ÙŠÙ…ÙƒÙ† Ù„ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø¢Ù†.');
            } else {
                console.error('Student not found with id:', id);
                this.showNotification('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø§Ù„Ø¨');
            }
        }
    },

    showNotification(message) {
        const notification = document.getElementById('notification');
        const notificationText = document.getElementById('notificationText');
        if (notification && notificationText) {
            notificationText.textContent = message;
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        } else {
            alert(message);
        }
    }
};

// Event Listeners
document.addEventListener('DOMContentLoaded', () => {
    // Check localhost
    if (window.location.protocol === 'file:') {
        const warning = document.getElementById('localhostWarning');
        if (warning) warning.style.display = 'block';
    }

    UI.updateStats();
    UI.renderStudents();
    createBulkUploadButton();

    if (document.getElementById('newStudentBtn')) {
        document.getElementById('newStudentBtn').addEventListener('click', () => {
            UI.openModal();
        });
    }

    if (document.getElementById('closeModalBtn')) {
        document.getElementById('closeModalBtn').addEventListener('click', () => {
            UI.closeModal();
        });
    }

    if (document.getElementById('cancelBtn')) {
        document.getElementById('cancelBtn').addEventListener('click', () => {
            UI.closeModal();
        });
    }

    if (UI.modal) {
        UI.modal.addEventListener('click', (e) => {
            if (e.target === UI.modal) {
                UI.closeModal();
            }
        });
    }

    if (document.getElementById('studentForm')) {
        document.getElementById('studentForm').addEventListener('submit', (e) => {
            e.preventDefault();

            const form = e.target;
            const editingId = form.dataset.editingId;

            const student = {
                studentName: document.getElementById('studentName').value,
                studentLevel: document.getElementById('studentLevel').value,
                studentGrade: document.getElementById('studentGrade').value,
                parentName: document.getElementById('parentName').value,
                parentEmail: document.getElementById('parentEmail').value,
                parentWhatsapp: document.getElementById('parentWhatsapp').value,
                sendMethod: document.getElementById('sendMethod').value,
                contractYear: document.getElementById('contractYear').value,
                contractTemplateId: document.getElementById('contractTemplate')?.value || null,
                customData: {}
            };

            // Capture custom fields
            const customInputs = document.querySelectorAll('#dynamicCustomFieldsContainer input');
            customInputs.forEach(input => {
                student.customData[input.dataset.customLabel] = input.value;
            });

            if (editingId) {
                student.id = editingId;
            }

            db.saveStudent(student);
            UI.closeModal();
            UI.updateStats();
            UI.renderStudents(); // Refresh grid
            UI.showNotification(editingId ? 'ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­' : 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­');
        });
    }
});

// Bulk Upload Feature
function createBulkUploadButton() {
    // Target the button group in students-page specifically
    const container = document.querySelector('#students-page .page-header > div:last-child');
    if (!container) return;

    // Check if duplicate
    if (document.getElementById('bulkUploadBtn')) return;

    const bulkBtn = document.createElement('button');
    bulkBtn.id = 'bulkUploadBtn';
    bulkBtn.className = 'btn btn-secondary';
    bulkBtn.innerHTML = `
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="17 8 12 3 7 8"></polyline>
            <line x1="12" y1="3" x2="12" y2="15"></line>
        </svg>
        Ø±ÙØ¹ Ù…Ù„Ù Excel/CSV
    `;
    bulkBtn.addEventListener('click', openBulkUploadModal);

    // Insert before the "Add Student" button
    container.insertBefore(bulkBtn, container.firstChild);
}

function createBulkSendButton() {
    const container = document.querySelector('#students-page .page-header > div:last-child');
    if (!container) return;

    if (document.getElementById('massSendBtn')) return;

    const sendBtn = document.createElement('button');
    sendBtn.id = 'massSendBtn';
    sendBtn.className = 'btn btn-primary';
    sendBtn.style.background = 'linear-gradient(135deg, #38b2ac 0%, #319795 100%)';
    sendBtn.innerHTML = `
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
            <line x1="22" y1="2" x2="11" y2="13"></line>
            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
        </svg>
        Ø¥Ø±Ø³Ø§Ù„ Ø¬Ù…Ø§Ø¹ÙŠ
    `;
    sendBtn.addEventListener('click', openBulkSendModal);

    container.appendChild(sendBtn);
}

function openBulkSendModal() {
    let students = db.getStudents().filter(s => s.contractStatus !== 'signed');

    // Check for selected students via checkboxes
    const selectedIds = Array.from(document.querySelectorAll('.student-checkbox:checked')).map(cb => cb.value);

    if (selectedIds.length > 0) {
        students = students.filter(s => selectedIds.includes(s.id));
    }

    if (students.length === 0) {
        alert(selectedIds.length > 0 ? 'Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø­Ø¯Ø¯ÙŠÙ† ÙˆÙ‚Ø¹ÙˆØ§ Ø§Ù„Ø¹Ù‚ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„.' : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¹Ù‚ÙˆØ¯ Ø­Ø§Ù„ÙŠØ§Ù‹.');
        return;
    }

    // Group students by parent (using phone number)
    const parentGroups = {};
    students.forEach(s => {
        const phone = s.parentWhatsapp.replace(/[^\d]/g, '');
        if (!parentGroups[phone]) {
            parentGroups[phone] = {
                parentName: s.parentName,
                phone: s.parentWhatsapp,
                students: []
            };
        }
        parentGroups[phone].students.push(s);
    });

    const parentList = Object.values(parentGroups);

    // Remove old modal if exists
    const oldModal = document.getElementById('bulkSendModal');
    if (oldModal) oldModal.remove();

    const modalHTML = `
        <div class="modal active" id="bulkSendModal">
            <div class="modal-content" style="max-width: 700px;">
                <div class="modal-header">
                    <h3>Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¹Ù‚ÙˆØ¯ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ</h3>
                    <button class="close-btn" onclick="document.getElementById('bulkSendModal').remove()">&times;</button>
                </div>
                <div class="form" style="padding-top: 0;">
                    <div style="background: #f7fafc; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border-right: 4px solid #38b2ac;">
                        <p>Ø³ÙŠØªÙ… ØªØ¬Ù…ÙŠØ¹ Ø¹Ù‚ÙˆØ¯ Ø§Ù„Ø£Ø¨Ù†Ø§Ø¡ Ù„Ù†ÙØ³ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± ÙÙŠ Ø±Ø³Ø§Ù„Ø© ÙˆØ§Ø­Ø¯Ø©.</p>
                        <strong>Ø¹Ø¯Ø¯ Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø£Ù…ÙˆØ±: ${parentList.length}</strong> | 
                        <strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨: ${students.length}</strong>
                    </div>

                    <div style="max-height: 400px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 1.5rem;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</th>
                                    <th>Ø§Ù„Ø£Ø¨Ù†Ø§Ø¡</th>
                                    <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${parentList.map((p, index) => `
                                    <tr>
                                        <td>
                                            <strong>${p.parentName}</strong><br>
                                            <small dir="ltr">${p.phone}</small>
                                        </td>
                                        <td>
                                            ${p.students.map(s => `<span class="status-badge" style="background:#edf2f7; color:#4a5568; margin:2px; display:inline-block">${s.studentName}</span>`).join('')}
                                        </td>
                                        <td>
                                            <button class="btn btn-small btn-primary" id="sendBatchBtn-${index}" onclick="UI.sendBulkBatch('${index}')">Ø¥Ø±Ø³Ø§Ù„</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>

                    <div class="form-actions">
                        <button class="btn btn-secondary" onclick="document.getElementById('bulkSendModal').remove()">Ø¥ØºÙ„Ø§Ù‚</button>
                        <button class="btn btn-primary" onclick="UI.sendAllBatches()" style="background: #2d3748;">Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„ÙƒÙ„ (ØªØªØ§Ø¨Ø¹ÙŠ)</button>
                    </div>
                </div>
            </div>
        </div>
    `;

    document.body.insertAdjacentHTML('beforeend', modalHTML);
    // Store current batch data in window for easy access
    window._currentBatchData = parentList;
}

UI.sendBulkBatch = function (index) {
    const parentData = window._currentBatchData[index];
    if (!parentData) return;

    const btn = document.getElementById(`sendBatchBtn-${index}`);
    if (btn) {
        btn.textContent = 'ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„';
        btn.style.background = '#cbd5e0';
        btn.disabled = true;
    }

    let basePath = window.location.href;
    if (basePath.indexOf('?') > -1) basePath = basePath.split('?')[0];
    if (basePath.endsWith('index.html')) basePath = basePath.replace('index.html', '');
    if (basePath.endsWith('/')) basePath = basePath.slice(0, -1);

    const templates = JSON.parse(localStorage.getItem('contractTemplates') || '[]');

    let linksText = '';
    parentData.students.forEach((student, idx) => {
        const template = templates.find(t => t.id === student.contractTemplateId) || templates.find(t => t.isDefault) || templates[0];

        const secureData = {
            i: student.id,
            s: student.studentName,
            l: student.studentLevel,
            g: student.studentGrade,
            p: student.parentName,
            e: student.parentEmail,
            w: student.parentWhatsapp,
            y: student.contractYear,
            t: template?.title || '',
            c: template?.content || '',
            st: 2
        };

        const compressed = LZString.compressToEncodedURIComponent(JSON.stringify(secureData));
        const url = `${basePath}/contract.html?c=${compressed}`;

        linksText += `\n${idx + 1}. *${student.studentName}*:\n${url}\n`;

        // Update status for each student
        db.updateStudentStatus(student.id, 'sent');
    });

    const message = `*Ø¹Ù‚ÙˆØ¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠØ©* ğŸ“

Ù…Ø±Ø­Ø¨Ø§Ù‹ ${parentData.parentName},
ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ø·Ù„Ø§Ø¹ Ø¹Ù„Ù‰ Ø¹Ù‚ÙˆØ¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø£Ø¨Ù†Ø§Ø¦Ùƒ ÙˆØªØ¹Ù…ÙŠØ¯Ù‡Ø§ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Ù‹:
${linksText}
Ø´ÙƒØ±Ø§Ù‹ Ù„ÙƒÙ… Ù„ØªØ¹Ø§ÙˆÙ†ÙƒÙ….`.trim();

    let phone = parentData.phone.replace(/[^\d]/g, '');
    if (phone.startsWith('05')) phone = '966' + phone.substring(1);
    else if (phone.startsWith('5')) phone = '966' + phone;

    const whatsappUrl = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;
    window.open(whatsappUrl, '_blank');

    this.updateStats();
    this.renderStudents();
};

UI.sendAllBatches = function () {
    const list = window._currentBatchData;
    if (!list) return;

    if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¨Ø¯Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ø¹Ø¯Ø¯ ${list.length} ÙˆÙ„ÙŠ Ø£Ù…Ø±ØŸ Ø³ÙŠØªÙ… ÙØªØ­ Ù†Ø§ÙØ°Ø© ÙˆØ§ØªØ³Ø§Ø¨ Ù„ÙƒÙ„ ÙˆØ§Ø­Ø¯ Ù…Ù†Ù‡Ù… ØªØªØ§Ø¨Ø¹ÙŠØ§Ù‹.`)) return;

    let i = 0;
    const sendNext = () => {
        if (i < list.length) {
            const btn = document.getElementById(`sendBatchBtn-${i}`);
            if (btn && !btn.disabled) {
                UI.sendBulkBatch(i);
            }
            i++;
            if (i < list.length) {
                // Wait small delay to avoid browser blocking multiple windows too aggressively
                setTimeout(sendNext, 1500);
            }
        }
    };
    sendNext();
};

function openBulkUploadModal() {
    // Remove if exists
    closeBulkUploadModal();

    const modalHTML = `
        <div class="modal active" id="bulkUploadModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Ø±ÙØ¹ Ù…Ù„Ù Ø·Ù„Ø§Ø¨ Ø¬Ù…Ø§Ø¹ÙŠ</h3>
                    <button class="close-btn" onclick="closeBulkUploadModal()">&times;</button>
                </div>
                <div class="form" style="padding-top: 0;">
                    <div class="upload-instructions">
                        <h4>ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù:</h4>
                        <ul>
                            <li>Ù‚Ù… Ø¨ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Excel (.xlsx) Ø£Ùˆ CSV (.csv)</li>
                            <li>ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø§Ù„Ù…Ù„Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„ØªØ§Ù„ÙŠØ© Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨: Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ØŒ Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©ØŒ Ø§Ù„ØµÙØŒ Ø§Ø³Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±ØŒ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØŒ Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ØŒ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ØŒ Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</li>
                        </ul>
                        <button class="btn btn-secondary" onclick="downloadTemplate()">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="7 10 12 15 17 10"></polyline>
                                <line x1="12" y1="15" x2="12" y2="3"></line>
                            </svg>
                            ØªØ­Ù…ÙŠÙ„ Ù†Ù…ÙˆØ°Ø¬ Excel
                        </button>
                    </div>
                    
                    <div class="upload-area" id="bulkUploadArea">
                        <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="#667eea" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="17 8 12 3 7 8"></polyline>
                            <line x1="12" y1="3" x2="12" y2="15"></line>
                        </svg>
                        <h3>Ø§Ø³Ø­Ø¨ Ø§Ù„Ù…Ù„Ù Ù‡Ù†Ø§ Ø£Ùˆ Ø§Ù†Ù‚Ø± Ù„Ù„ØªØ­Ù…ÙŠÙ„</h3>
                        <p>Excel (.xlsx) Ø£Ùˆ CSV (.csv)</p>
                        <input type="file" id="bulkFileInput" accept=".xlsx,.csv" hidden>
                        <button class="btn btn-secondary" onclick="document.getElementById('bulkFileInput').click()">ØªØµÙØ­ Ø§Ù„Ù…Ù„ÙØ§Øª</button>
                    </div>

                    <div id="bulkPreview" style="display: none; margin-top: 1.5rem;">
                        <h4 style="margin-bottom: 1rem;">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:</h4>
                        <div style="max-height: 300px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px;">
                            <table class="data-table" id="previewTable"></table>
                        </div>
                        <div class="form-actions" style="margin-top: 1.5rem;">
                            <button class="btn btn-secondary" onclick="closeBulkUploadModal()">Ø¥Ù„ØºØ§Ø¡</button>
                            <button class="btn btn-primary" onclick="confirmBulkUpload()">
                                Ø±ÙØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨ (<span id="studentCount">0</span> Ø·Ø§Ù„Ø¨)
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;

    document.body.insertAdjacentHTML('beforeend', modalHTML);

    const fileInput = document.getElementById('bulkFileInput');
    const uploadArea = document.getElementById('bulkUploadArea');

    uploadArea.addEventListener('click', () => fileInput.click());

    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.style.borderColor = '#667eea';
    });

    uploadArea.addEventListener('dragleave', () => {
        uploadArea.style.borderColor = '#e5e7eb';
    });

    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.style.borderColor = '#e5e7eb';
        const file = e.dataTransfer.files[0];
        if (file) handleBulkFile(file);
    });

    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) handleBulkFile(file);
    });
}

let bulkStudentsData = [];

function handleBulkFile(file) {
    const reader = new FileReader();

    reader.onload = (e) => {
        const data = e.target.result;

        if (file.name.endsWith('.csv')) {
            parseCSV(data);
        } else {
            UI.showNotification('ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ù„Ù CSV Ø£Ùˆ ØªØ«Ø¨ÙŠØª Ù…ÙƒØªØ¨Ø© Ù„Ù‚Ø±Ø§Ø¡Ø© Excel');
        }
    };

    if (file.name.endsWith('.csv')) {
        reader.readAsText(file);
    } else {
        reader.readAsArrayBuffer(file);
    }
}

function parseCSV(data) {
    // Detect separator (semicolon for Excel Arabic/Euro, comma for standard)
    const firstLine = data.split('\n')[0];
    const separator = firstLine.includes(';') ? ';' : ',';

    // Clear any "sep=;" markers if present (Excel trick)
    const processedData = data.replace(/^sep=.\r?\n/, '');

    const lines = processedData.trim().split('\n');
    bulkStudentsData = [];

    for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split(separator);
        if (values.length >= 2) { // Allow minimal data
            bulkStudentsData.push({
                studentName: values[0] ? values[0].trim() : '',
                studentLevel: values[1] ? values[1].trim() : '',
                studentGrade: values[2] ? values[2].trim() : '',
                parentName: values[3] ? values[3].trim() : '',
                parentEmail: values[4] ? values[4].trim() : '',
                parentWhatsapp: values[5] ? values[5].trim() : '',
                sendMethod: values[6] ? values[6].trim() : 'whatsapp',
                contractYear: values[7] ? values[7].trim() : ''
            });
        }
    }

    displayBulkPreview();
}

function displayBulkPreview() {
    const preview = document.getElementById('bulkPreview');
    const table = document.getElementById('previewTable');
    const count = document.getElementById('studentCount');

    count.textContent = bulkStudentsData.length;

    let tableHTML = `
        <thead>
            <tr>
                <th>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                <th>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</th>
                <th>Ø§Ù„ØµÙ</th>
                <th>ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</th>
                <th>Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨</th>
            </tr>
        </thead>
        <tbody>
    `;

    bulkStudentsData.forEach(student => {
        tableHTML += `
            <tr>
                <td>${student.studentName}</td>
                <td>${student.studentLevel || '-'}</td>
                <td>${student.studentGrade}</td>
                <td>${student.parentName}</td>
                <td>${student.parentWhatsapp}</td>
            </tr>
        `;
    });

    tableHTML += '</tbody>';
    table.innerHTML = tableHTML;
    preview.style.display = 'block';
}

function confirmBulkUpload() {
    db.saveBulkStudents(bulkStudentsData);
    closeBulkUploadModal();
    UI.updateStats();
    UI.renderStudents();
    UI.showNotification(`ØªÙ… Ø¥Ø¶Ø§ÙØ© ${bulkStudentsData.length} Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­!`);
    bulkStudentsData = [];
}

function closeBulkUploadModal() {
    const modal = document.getElementById('bulkUploadModal');
    if (modal) modal.remove();
}

function downloadTemplate() {
    // Use semicolon (;) which is better for Excel in Arabic regions
    // Add "sep=;" at the top to tell Excel exactly what the separator is
    const header = 'Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨;Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©;Ø§Ù„ØµÙ;Ø§Ø³Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±;Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ;Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨;Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„;Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©';
    const example = 'Ù…Ø­Ù…Ø¯ Ø£Ø­Ù…Ø¯;Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©;5;Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯;ahmad@example.com;+966501234567;whatsapp;2024-2025';
    const csvContent = `sep=;\n${header}\n${example}`;

    const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'Ù†Ù…ÙˆØ°Ø¬_Ø§Ù„Ø·Ù„Ø§Ø¨.csv';
    link.click();
}

// ---------------------------------------------------------
// APP INITIALIZATION & NAVIGATION LOGIC
// ---------------------------------------------------------

const ContractUI = {
    insertVariable(variable) {
        const textarea = document.getElementById('contractText');
        if (!textarea) return;

        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const text = textarea.value;

        textarea.value = text.substring(0, start) + variable + text.substring(end);
        textarea.focus();
        textarea.selectionStart = textarea.selectionEnd = start + variable.length;
    },

    renderSignedContracts(filteredStudents = null) {
        const students = filteredStudents || db.getStudents().filter(s => s.contractStatus === 'signed' || s.contractStatus === 'verified'); // Show signed or verified
        const tableBody = document.getElementById('signedContractsTableBody');

        if (!tableBody) return;

        if (students.length === 0) {
            const message = filteredStudents ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ø¨Ø­Ø«' : 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù‚ÙˆØ¯ Ù…ÙˆÙ‚Ø¹Ø© Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†';
            tableBody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding: 2rem;">${message}</td></tr>`;
            return;
        }

        tableBody.innerHTML = students.map(student => `
            <tr>
                <td><input type="checkbox" class="contract-check" value="${student.id}"></td>
                <td>${student.studentName}</td>
                <td>${student.parentName}</td>
                <td>${student.signedAt ? new Date(student.signedAt).toLocaleDateString('ar-SA') : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                <td>
                    <span class="status-badge ${student.contractStatus === 'verified' ? 'status-signed' : 'status-sent'}">
                        ${student.contractStatus === 'verified' ? 'Ù…ÙˆØ«Ù‚' : 'Ù…ÙˆÙ‚Ø¹'}
                    </span>
                </td>
                <td>
                    <div style="display: flex; gap: 5px;">
                        ${student.contractStatus === 'signed' ? `
                        <button class="btn-icon" onclick="markAsSigned('${student.id}')" title="ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… ÙˆØ§Ù„ØªÙˆØ«ÙŠÙ‚" style="color: #38b2ac;">
                             <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                        </button>
                        ` : ''}
                        <button class="btn-icon" onclick="UI.previewContract('${student.id}')" title="Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø¹Ù‚Ø¯">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                        </button>
                        <button class="btn-icon" onclick="UI.downloadContractPdf('${student.id}')" title="ØªØ­Ù…ÙŠÙ„ PDF Ø§Ù„Ù…ÙˆØ«Ù‚">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
    },

    downloadSelectedContracts() {
        const checked = document.querySelectorAll('.contract-check:checked');
        if (checked.length === 0) {
            alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø¹Ù‚Ø¯ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„ØªØ­Ù…ÙŠÙ„');
            return;
        }

        alert(`Ø³ÙŠØªÙ… ÙØªØ­ ${checked.length} Ø¹Ù‚ÙˆØ¯ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©... ÙŠØ±Ø¬Ù‰ Ø­ÙØ¸Ù‡Ø§ ÙƒÙ…Ù„ÙØ§Øª PDF`);

        checked.forEach((checkbox, index) => {
            setTimeout(() => {
                UI.downloadContractPdf(checkbox.value);
            }, index * 800); // Reduced delay from 1500ms to 800ms
        });
    },

    renderTemplates() {
        const grid = document.getElementById('contractsGrid');
        if (!grid) return;

        const templates = JSON.parse(localStorage.getItem('contractTemplates') || '[]');

        if (templates.length === 0) {
            grid.innerHTML = `
                <div style="grid-column: 1/-1; text-align: center; padding: 3rem; background: #f9fafb; border-radius: 8px;">
                    <p style="color: #666;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ù…Ø§Ø°Ø¬ Ø¹Ù‚ÙˆØ¯ Ù…Ø­ÙÙˆØ¸Ø©. Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù‚Ø¯ Ø¬Ø¯ÙŠØ¯.</p>
                </div>
            `;
            return;
        }

        grid.innerHTML = templates.map(t => `
            <div class="contract-card">
                <div class="contract-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                        <polyline points="10 9 9 9 8 9"></polyline>
                    </svg>
                </div>
                <div class="contract-info">
                    <h3>${t.title} ${t.isDefault ? '<span style="font-size:0.7em; background:#e6fffa; color:#38b2ac; padding:2px 6px; border-radius:4px;">Ø§ÙØªØ±Ø§Ø¶ÙŠ</span>' : ''}</h3>
                    <p>ØªÙ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: ${new Date(t.createdAt).toLocaleDateString('ar-SA')}</p>
                </div>
                <div class="contract-actions-btns" style="margin-top: 1rem; display:flex; gap:0.5rem;">
                    <button class="btn btn-primary btn-small" onclick="ContractUI.editTemplate('${t.id}')" style="width:100%;">ØªØ¹Ø¯ÙŠÙ„</button>
                    <button class="btn btn-secondary btn-small" onclick="ContractUI.deleteTemplate('${t.id}')" style="width:100%; color: #ef4444; border-color: #ef4444;">Ø­Ø°Ù</button>
                </div>
            </div>
        `).join('');
    },

    editTemplate(id) {
        const templates = JSON.parse(localStorage.getItem('contractTemplates') || '[]');
        const template = templates.find(t => t.id === id);

        if (template) {
            document.getElementById('contractTitle').value = template.title;
            document.getElementById('contractText').value = template.content;
            document.getElementById('setAsDefault').checked = template.isDefault || false;

            // Open modal
            document.getElementById('contractEditorModal').classList.add('active');

            // Handle save as update (will create new for now, ideally update ID)
            // Ideally we should update the form submission logic to handle edits, 
            // but for simplicity, the user can just save a new one and delete old, or we can improve this later.
            // Let's add a hidden ID field to support updates properly.

            const form = document.getElementById('contractForm');
            form.dataset.editingId = id;
        }
    },

    deleteTemplate(id) {
        if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ØŸ')) {
            let templates = JSON.parse(localStorage.getItem('contractTemplates') || '[]');
            templates = templates.filter(t => t.id !== id);
            localStorage.setItem('contractTemplates', JSON.stringify(templates));
            this.renderTemplates();
            UI.showNotification('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù†Ù…ÙˆØ°Ø¬');
        }
    }
};

function markAsSigned(id) {
    console.log('markAsSigned called with id:', id);

    if (confirm('Ù‡Ù„ ØªÙˆØ¯ ØªØ£ÙƒÙŠØ¯ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù† ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±ØŸ\n\nØ³ÙŠØªÙ… ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¥Ù„Ù‰ "Ù…ÙˆØ«Ù‚" ÙˆØ¥Ø¶Ø§ÙØªÙ‡ Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù‚ÙˆØ¯.')) {
        const students = db.getStudents();
        const student = students.find(s => String(s.id) === String(id));

        console.log('Found student:', student ? student.studentName : 'NOT FOUND');

        if (student) {
            student.contractStatus = 'verified';
            student.verifiedAt = new Date().toISOString();

            // If no signature exists, add a placeholder note
            if (!student.signedAt) {
                student.signedAt = new Date().toISOString();
            }

            db.saveStudent(student);

            UI.updateStats();
            UI.renderStudents();
            if (typeof ContractUI !== 'undefined') {
                ContractUI.renderSignedContracts();
            }
            UI.showNotification('âœ… ØªÙ… ØªÙˆØ«ÙŠÙ‚ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¹Ù‚Ø¯ Ø¨Ù†Ø¬Ø§Ø­');
        } else {
            console.error('Student not found with id:', id);
            UI.showNotification('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø§Ù„Ø¨');
        }
    }
}

function initContractModal() {
    const modal = document.getElementById('contractEditorModal');
    const openBtn = document.getElementById('newContractBtn');
    const closeBtn = document.getElementById('closeContractModalBtn');
    const cancelBtn = document.getElementById('cancelContractBtn');

    if (openBtn) {
        openBtn.addEventListener('click', () => {
            modal.classList.add('active');
        });
    }

    const closeModal = () => {
        modal.classList.remove('active');
    };

    if (closeBtn) closeBtn.addEventListener('click', closeModal);
    if (cancelBtn) cancelBtn.addEventListener('click', closeModal);

    // Tab Switching Logic
    const tabs = document.querySelectorAll('.input-tab');
    const methods = {
        'write': document.getElementById('writeMethod'),
        'upload': document.getElementById('uploadMethod')
    };

    if (tabs.length > 0) {
        // Set first tab active by default if none
        if (!document.querySelector('.input-tab.active')) tabs[0].classList.add('active');

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                const methodType = tab.dataset.method;
                if (methodType === 'write') {
                    methods['write'].style.display = 'block';
                    methods['upload'].style.display = 'none';
                } else {
                    methods['write'].style.display = 'none';
                    methods['upload'].style.display = 'block';
                }
            });
        });
    }

    // File Upload Handler
    const browseBtn = document.getElementById('browseContractFile');
    const fileInput = document.getElementById('contractFileInput');
    const uploadArea = document.getElementById('contractUploadArea');

    const handleContractFile = (file) => {
        if (!file) return;

        const extension = file.name.split('.').pop().toLowerCase();

        if (extension === 'txt') {
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('contractText').value = e.target.result;
                if (tabs[0]) tabs[0].click();
                UI.showNotification('ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù†Øµ Ø¨Ù†Ø¬Ø§Ø­');
            };
            reader.readAsText(file);
        } else if (['doc', 'docx', 'pdf'].includes(extension)) {
            alert(`ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù (${extension.toUpperCase()}).\n\nÙ†Ø¸Ø±Ø§Ù‹ Ù„Ø£Ù† Ù‡Ø°Ø§ Ø§Ù„Ù†ÙˆØ¹ Ù…Ù† Ø§Ù„Ù…Ù„ÙØ§Øª ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ù…Ø¹Ù‚Ø¯Ø©ØŒ ÙŠØ±Ø¬Ù‰ ÙØªØ­ Ø§Ù„Ù…Ù„Ù ÙˆÙ†Ø³Ø® Ø§Ù„Ù†Øµ ÙˆÙ„ØµÙ‚Ù‡ ÙÙŠ Ø®Ø§Ù†Ø© "ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù†Øµ" Ù„Ø¶Ù…Ø§Ù† Ø¹Ù…Ù„ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª (Ù…Ø«Ù„ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨) Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­.`);
            if (tabs[0]) tabs[0].click();
        } else {
            alert('Ø¹ÙÙˆØ§Ù‹ØŒ ÙŠØ±Ø¬Ù‰ Ø±ÙØ¹ Ù…Ù„Ù Ù†ØµÙŠ Ø£Ùˆ Word Ø£Ùˆ PDF.');
        }
    };

    if (browseBtn && fileInput && uploadArea) {
        browseBtn.addEventListener('click', () => fileInput.click());

        fileInput.addEventListener('change', (e) => handleContractFile(e.target.files[0]));

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#667eea';
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#e5e7eb';
            handleContractFile(e.dataTransfer.files[0]);
        });
    }
}

function initContractForm() {
    const form = document.getElementById('contractForm');
    if (!form) return;

    form.addEventListener('submit', (e) => {
        e.preventDefault();

        const title = document.getElementById('contractTitle').value;
        const content = document.getElementById('contractText').value;
        const isDefault = document.getElementById('setAsDefault').checked;

        if (!title || !content) {
            alert('ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆÙ†Øµ Ø§Ù„Ø¹Ù‚Ø¯');
            return;
        }

        let templates = JSON.parse(localStorage.getItem('contractTemplates') || '[]');
        const editingId = form.dataset.editingId;

        if (editingId) {
            // Update existing
            const index = templates.findIndex(t => t.id === editingId);
            if (index !== -1) {
                templates[index] = {
                    ...templates[index],
                    title,
                    content,
                    isDefault,
                    updatedAt: new Date().toISOString()
                };
            }
        } else {
            // Create new
            const newTemplate = {
                id: Date.now().toString(),
                title: title,
                content: content,
                isDefault: isDefault,
                createdAt: new Date().toISOString()
            };

            if (isDefault) {
                templates.forEach(t => t.isDefault = false);
            } else if (templates.length === 0) {
                newTemplate.isDefault = true;
            }
            templates.push(newTemplate);
        }

        // Handle Default Flag globally
        if (isDefault) {
            templates.forEach(t => {
                if (t.id !== (editingId || templates[templates.length - 1].id)) {
                    t.isDefault = false;
                }
            });
        }

        localStorage.setItem('contractTemplates', JSON.stringify(templates));

        UI.showNotification(editingId ? 'ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø¨Ù†Ø¬Ø§Ø­' : 'ØªÙ… Ø­ÙØ¸ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¹Ù‚Ø¯ Ø¨Ù†Ø¬Ø§Ø­');
        document.getElementById('contractEditorModal').classList.remove('active');
        form.reset();
        delete form.dataset.editingId; // Clear editing state

        // Refresh grid
        ContractUI.renderTemplates();
    });
}

function initSearch() {
    const searchInput = document.getElementById('studentSearch');
    const signedSearchInput = document.getElementById('signedContractSearch');

    if (searchInput) {
        searchInput.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase().trim();
            const students = db.getStudents();

            if (query === '') {
                UI.renderStudents(); // Reset
                return;
            }

            const filtered = students.filter(s =>
                (s.studentName && s.studentName.toLowerCase().includes(query)) ||
                (s.parentName && s.parentName.toLowerCase().includes(query)) ||
                (s.parentWhatsapp && s.parentWhatsapp.includes(query)) ||
                (s.studentGrade && s.studentGrade.toString().includes(query))
            );

            UI.renderStudents(filtered);
        });
    }

    if (signedSearchInput) {
        signedSearchInput.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase().trim();
            const signedStudents = db.getStudents().filter(s => s.contractStatus === 'signed' || s.contractStatus === 'verified');

            if (query === '') {
                ContractUI.renderSignedContracts(); // Reset
                return;
            }

            const filtered = signedStudents.filter(s =>
                (s.studentName && s.studentName.toLowerCase().includes(query)) ||
                (s.parentName && s.parentName.toLowerCase().includes(query)) ||
                (s.parentWhatsapp && s.parentWhatsapp.includes(query))
            );

            ContractUI.renderSignedContracts(filtered);
        });
    }
}

function initTabs() {
    const navLinks = document.querySelectorAll('.nav-link');
    const pages = document.querySelectorAll('.page');

    navLinks.forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const pageId = link.dataset.page;

            // Update active link
            navLinks.forEach(l => l.classList.remove('active'));
            link.classList.add('active');

            // Update active page
            pages.forEach(p => p.classList.remove('active'));
            document.getElementById(`${pageId}-page`).classList.add('active');

            // Specialized page loading
            if (pageId === 'dashboard') {
                UI.updateStats();
                UI.renderStudents();
            } else if (pageId === 'contracts') {
                ContractUI.renderSignedContracts();
            } else if (pageId === 'settings') {
                const settings = db.getSettings();
                document.getElementById('schoolStampInput').value = settings.schoolStampText || '';
                document.getElementById('adminUsernameSetting').value = settings.adminUsername || 'admin';
                document.getElementById('adminPassSetting').value = settings.adminPassword || 'admin';
                document.getElementById('schoolLevelsInput').value = (settings.levels || []).join(', ');
                document.getElementById('schoolGradesInput').value = (settings.grades || []).join(', ');
                if (document.getElementById('customFieldsSetting')) {
                    document.getElementById('customFieldsSetting').value = (settings.customFields || []).join(', ');
                }
                if (settings.schoolLogo) {
                    document.getElementById('settingsLogoPreview').src = settings.schoolLogo;
                }
                UI.updateStampPreview();
            }
        });
    });
}

UI.saveSettings = function () {
    const stampText = document.getElementById('schoolStampInput').value;
    const adminUser = document.getElementById('adminUsernameSetting').value;
    const adminPass = document.getElementById('adminPassSetting').value;
    const levels = document.getElementById('schoolLevelsInput').value.split(',').map(s => s.trim()).filter(s => s);
    const grades = document.getElementById('schoolGradesInput').value.split(',').map(s => s.trim()).filter(s => s);
    const logo = document.getElementById('settingsLogoPreview').src; // Get current src (might be base64)

    const customFieldsRaw = document.getElementById('customFieldsSetting')?.value || '';
    const customFields = customFieldsRaw.split(',').map(s => s.trim()).filter(s => s);

    db.saveSettings({
        schoolStampText: stampText,
        adminUsername: adminUser,
        adminPassword: adminPass,
        levels: levels,
        grades: grades,
        customFields: customFields,
        schoolLogo: logo.startsWith('data:') ? logo : '' // Save only if it's base64
    });

    UI.applyBranding();
    UI.populateDynamicSelects();
    UI.showNotification('âœ… ØªÙ… Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
};

UI.handleLogoUpload = function (input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function (e) {
            document.getElementById('settingsLogoPreview').src = e.target.result;
        };
        reader.readAsDataURL(input.files[0]);
    }
};

UI.applyBranding = function () {
    const settings = db.getSettings();
    const logo = settings.schoolLogo || 'assets/logo.png';

    if (document.getElementById('loginLogo')) document.getElementById('loginLogo').src = logo;
    if (document.getElementById('navLogo')) document.getElementById('navLogo').src = logo;
    if (document.getElementById('settingsLogoPreview')) document.getElementById('settingsLogoPreview').src = logo;
};

UI.updateStampPreview = function () {
    const input = document.getElementById('schoolStampInput');
    const preview = document.getElementById('stampPreviewText');
    if (input && preview) {
        preview.textContent = input.value || 'Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©';
    }
};

UI.handleLogin = function () {
    const userInput = document.getElementById('adminUserInput');
    const passInput = document.getElementById('adminPassInput');
    const settings = db.getSettings();

    if (!userInput || !passInput) {
        console.error('Login inputs not found');
        return;
    }

    const inputUser = userInput.value.trim().toLowerCase();
    const inputPass = passInput.value.trim();

    // Default credentials as a permanent fallback
    const defaultUser = 'admin';
    const defaultPass = 'admin';

    const targetUser = String(settings.adminUsername || defaultUser).toLowerCase();
    const targetPass = String(settings.adminPassword || defaultPass);

    console.log('Attempting login...');

    if ((inputUser === targetUser && inputPass === targetPass) ||
        (inputUser === defaultUser && inputPass === defaultPass)) {

        sessionStorage.setItem('isAdminAuthenticated', 'true');
        const overlay = document.getElementById('loginOverlay');
        if (overlay) {
            overlay.style.opacity = '0';
            setTimeout(() => {
                overlay.style.display = 'none';
            }, 300);
        }
        UI.showNotification('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­');
    } else {
        const error = document.getElementById('loginError');
        if (error) {
            error.style.display = 'block';
            error.innerHTML = `Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©.<br>
                <small style="display:block; margin-top:0.5rem; color:#718096;">ØªÙ„Ù…ÙŠØ­: Ø¬Ø±Ø¨ admin / admin</small>
                <small style="cursor:pointer; text-decoration: underline; color: var(--primary-solid); display:block; margin-top:0.5rem;" onclick="UI.emergencyReset()">Ù†Ø³ÙŠØª Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ØŸ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ</small>`;
        }
    }
};

UI.emergencyReset = function () {
    if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© (admin / admin)ØŸ')) {
        const settings = db.getSettings();
        settings.adminUsername = 'admin';
        settings.adminPassword = 'admin';
        db.saveSettings(settings);
        sessionStorage.setItem('isAdminAuthenticated', 'true');
        location.reload();
    }
};

UI.handleLogout = function () {
    sessionStorage.removeItem('isAdminAuthenticated');
    window.location.reload();
};

UI.populateDynamicSelects = function () {
    const settings = db.getSettings();
    const levelSelect = document.getElementById('studentLevel');
    const gradeSelect = document.getElementById('studentGrade');
    const customContainer = document.getElementById('dynamicCustomFieldsContainer');

    if (levelSelect) {
        levelSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±Ø­Ù„Ø©</option>' +
            settings.levels.map(l => `<option value="${l}">${l}</option>`).join('');
    }

    if (gradeSelect) {
        gradeSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ØµÙ</option>' +
            settings.grades.map(g => `<option value="${g}">${g}</option>`).join('');
    }

    if (customContainer) {
        customContainer.innerHTML = (settings.customFields || []).map(f => `
            <div class="form-group" style="flex: 1 1 200px;">
                <label for="custom_${f}">${f}</label>
                <input type="text" id="custom_${f}" data-custom-label="${f}" placeholder="Ø£Ø¯Ø®Ù„ ${f}">
            </div>
        `).join('');
    }
};

function startApp() {
    try {
        console.log('Starting App...');
        UI.applyBranding();

        // Add Login Listeners
        const userIn = document.getElementById('adminUserInput');
        const passIn = document.getElementById('adminPassInput');
        if (userIn) userIn.addEventListener('keypress', (e) => e.key === 'Enter' && UI.handleLogin());
        if (passIn) passIn.addEventListener('keypress', (e) => e.key === 'Enter' && UI.handleLogin());

        // Bulk Select Listeners defined in renderStudents but "Select All" needs init
        const selectAll = document.getElementById('selectAllDashboard');
        if (selectAll) {
            selectAll.addEventListener('change', (e) => {
                const checkboxes = document.querySelectorAll('.student-checkbox');
                checkboxes.forEach(cb => cb.checked = e.target.checked);
                UI.handleSelectionChange();
            });
        }

        // Check Auth
        if (sessionStorage.getItem('isAdminAuthenticated') === 'true') {
            const overlay = document.getElementById('loginOverlay');
            if (overlay) overlay.style.display = 'none';
        }

        UI.updateStats();
        UI.renderStudents();
        UI.populateDynamicSelects();
        UI.initCharts();
        UI.initTheme();
        if (typeof createBulkUploadButton === 'function') createBulkUploadButton();
        if (typeof createBulkSendButton === 'function') createBulkSendButton();
        if (typeof initTabs === 'function') initTabs();
        if (typeof initContractModal === 'function') initContractModal();
        if (typeof initContractForm === 'function') initContractForm();
        if (typeof initSearch === 'function') initSearch();

        // Initial Render
        if (typeof ContractUI !== 'undefined') {
            ContractUI.renderSignedContracts();
            ContractUI.renderTemplates();
        }

        // Listen for storage changes (Real-time update when parent signs)
        window.removeEventListener('storage', handleStorageChange);
        window.addEventListener('storage', handleStorageChange);

        console.log('App Started Successfully');
    } catch (e) {
        console.error('CRITICAL ERROR STARTING APP:', e);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…: ' + e.message + '\n' + e.stack);
    }
}

UI.initTheme = function () {
    const themeToggle = document.getElementById('themeToggle');
    const sunIcon = themeToggle?.querySelector('.sun');
    const moonIcon = themeToggle?.querySelector('.moon');

    const savedTheme = localStorage.getItem('appTheme') || 'light';
    if (savedTheme === 'dark') {
        document.body.classList.add('dark-mode');
        if (sunIcon) sunIcon.style.display = 'none';
        if (moonIcon) moonIcon.style.display = 'block';
    }

    themeToggle?.addEventListener('click', () => {
        const isDark = document.body.classList.toggle('dark-mode');
        localStorage.setItem('appTheme', isDark ? 'dark' : 'light');

        if (sunIcon && moonIcon) {
            sunIcon.style.display = isDark ? 'none' : 'block';
            moonIcon.style.display = isDark ? 'block' : 'none';
        }

        // Refresh charts for new theme
        UI.initCharts();
    });
};

UI.charts = {};

UI.initCharts = function () {
    const stats = db.getStats();
    const isDark = document.body.classList.contains('dark-mode');
    const textColor = isDark ? '#94a3b8' : '#64748b';
    const gridColor = isDark ? '#334155' : '#e2e8f0';

    // Cleanup existing charts
    if (UI.charts.stats) UI.charts.stats.destroy();
    if (UI.charts.dist) UI.charts.dist.destroy();

    const ctx1 = document.getElementById('statsChart')?.getContext('2d');
    if (ctx1) {
        UI.charts.stats = new Chart(ctx1, {
            type: 'bar',
            data: {
                labels: ['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨', 'Ù…ÙˆÙ‚Ø¹Ø©', 'Ø§Ù†ØªØ¸Ø§Ø±', 'Ù…Ø±Ø³Ù„Ø©'],
                datasets: [{
                    label: 'Ø§Ù„Ø¹Ø¯Ø¯',
                    data: [stats.total, stats.signed, stats.pending, stats.sent],
                    backgroundColor: ['#6366f1', '#10b981', '#f59e0b', '#3b82f6'],
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { grid: { color: gridColor }, ticks: { color: textColor } },
                    x: { grid: { display: false }, ticks: { color: textColor } }
                }
            }
        });
    }

    const ctx2 = document.getElementById('distributionChart')?.getContext('2d');
    if (ctx2) {
        UI.charts.dist = new Chart(ctx2, {
            type: 'doughnut',
            data: {
                labels: ['Ù…ÙˆÙ‚Ø¹Ø©', 'Ø£Ø®Ø±Ù‰'],
                datasets: [{
                    data: [stats.signed, stats.total - stats.signed],
                    backgroundColor: ['#10b981', '#e2e8f0'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '70%',
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { color: textColor, font: { family: 'Cairo' } }
                    }
                }
            }
        });
    }
};

function handleStorageChange(e) {
    if (e.key === 'students') {
        console.log('Detected remote students change, refreshing UI...');
        db.updateFromRemote();
        UI.showNotification('ğŸ”„ ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹');
    }
}

// Listen for storage changes from other tabs/windows
window.addEventListener('storage', handleStorageChange);

// Manual refresh function
UI.refreshData = function () {
    console.log('Manual refresh triggered');
    this.updateStats();
    this.renderStudents();
    if (typeof ContractUI !== 'undefined') {
        ContractUI.renderSignedContracts();
    }
    this.showNotification('ğŸ”„ ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
};

// Auto-refresh every 5 seconds to catch changes
setInterval(() => {
    if (document.visibilityState === 'visible') {
        UI.updateStats();
        UI.renderStudents();
        if (typeof ContractUI !== 'undefined' && document.getElementById('signedContractsTableBody')) {
            ContractUI.renderSignedContracts();
        }
    }
}, 5000);

// Make available globally
window.db = db;
window.UI = UI;
window.ContractUI = ContractUI;
window.markAsSigned = markAsSigned;

// Call startApp when DOM is ready (re-run safely)
// Call startApp when DOM is ready (re-run safely)
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
        startApp();
        checkFirebase();
    });
} else {
    startApp();
    checkFirebase();
}

function checkFirebase() {
    setTimeout(() => {
        if (typeof isFirebaseConfigured !== 'undefined' && !isFirebaseConfigured) {
            console.warn('Firebase setup required');
            // Only show alert if we are on the admin dashboard
            if (document.getElementById('statsGrid')) {
                const overlay = document.createElement('div');
                overlay.innerHTML = `
                    <div style="position: fixed; bottom: 20px; right: 20px; background: #fff3cd; color: #856404; padding: 15px; border-radius: 8px; border: 1px solid #ffeeba; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 9999; max-width: 300px;">
                        <h4 style="margin-top:0;font-size:16px;">âš ï¸ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ© ØºÙŠØ± Ù…ÙØ¹Ù„Ø©</h4>
                        <p style="font-size:12px;margin-bottom:10px;">Ù„ØªÙ…ÙƒÙŠÙ† Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨ÙŠÙ† Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© (Ø¬ÙˆØ§Ù„ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± ÙˆÙ„Ø§Ø¨ØªÙˆØ¨ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©)ØŒ ÙŠØ¬Ø¨ Ø¥Ø¹Ø¯Ø§Ø¯ Firebase.</p>
                        <button onclick="this.parentElement.remove()" style="background:#856404;color:white;border:none;padding:5px 10px;border-radius:4px;cursor:pointer;">Ø¥ØºÙ„Ø§Ù‚</button>
                    </div>
                `;
                document.body.appendChild(overlay);
            }
        } else if (typeof isFirebaseConfigured !== 'undefined' && isFirebaseConfigured) {
            UI.showNotification('âœ… Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ© Ù†Ø´Ø·Ø©');
        }
    }, 2000);
}
